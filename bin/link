#!/bin/sh

set -e

toolchain=$(dirname $0)/..

if [ $# -lt 3 ] || [ "$1" != "-o" ]
then
	echo >&2 "usage: $0 -o NAME.wasm OBJECT..."
	exit 2
fi

output="$2"
shift 2

tempname=$(echo "${output}" | sed 's/\.wasm$//')_link

${toolchain}/llvm-build/bin/llvm-link -o "${tempname}.bc" "$@"
${toolchain}/llvm-build/bin/llc -o "${tempname}.s" "${tempname}.bc"
${toolchain}/binaryen-build/bin/s2wasm --start=main "${tempname}.s" > "${tempname}.wast"
${toolchain}/wabt/out/wast2wasm -o "${output}" "${tempname}.wast"
